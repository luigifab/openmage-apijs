"use strict";
/**
 * Copyright 2009-2014 | Fabrice Creuzot (luigifab) <code~luigifab~info>
 * (5.0.0) http://www.luigifab.info/magento/wiki/apijs
 *
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
if(!Function.prototype.hasOwnProperty('bind')){Function.prototype.bind=function(owner){var that=this,args=Array.prototype.slice.call(arguments,1);return function(){return that.apply(owner,(args.length===0)?arguments:(arguments.length===0)?args:args.concat(Array.prototype.slice.call(arguments,0)));};};}
if(!String.prototype.hasOwnProperty('trim')){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');};}
var apijs={core:{},version:500,config:{lang:'auto',debug:false,dialog:{closeOnClick:false,restrictNavigation:true,emotes:true,imagePrev:null,imageNext:null,imageClose:null},slideshow:{ids:'slideshow'}},start:function(){this.i18n=new apijs.core.i18n();if(typeof setApijsLang==='function')
setApijsLang();this.i18n.init();if(typeof setApijsConfig==='function')
setApijsConfig();this.dialog=new apijs.core.dialog();this.upload=new apijs.core.upload();this.slideshow=new apijs.core.slideshow();this.slideshow.init();if(typeof setApijsRewrites==='function')
setApijsRewrites();},openTab:function(ev){ev.preventDefault();window.open(this.href);},inArray:function(needle,haystack){var key;if(needle instanceof Array){for(key in needle)if(needle.hasOwnProperty(key)){if(apijs.inArray(needle[key],haystack))
return true;}}
else{for(key in haystack)if(haystack.hasOwnProperty(key)){if(!isNaN(key)&&(haystack[key]===needle))
return true;}}
return false;},serialize:function(form){var nodeName,nodeType,i,j,q=[];for(i=form.elements.length-1;i>=0;i=i-1){nodeName=form.elements[i].nodeName;nodeType=form.elements[i].type;if(nodeName==='INPUT'){if(this.inArray(nodeType,['checkbox','radio'])){if(form.elements[i].checked)
q.push(form.elements[i].getAttribute('name')+'='+encodeURIComponent(form.elements[i].value));}
else if(!this.inArray(nodeType,['file','button','reset','submit'])){q.push(form.elements[i].getAttribute('name')+'='+encodeURIComponent(form.elements[i].value));}}
else if(nodeName==='TEXTAREA'){q.push(form.elements[i].getAttribute('name')+'='+encodeURIComponent(form.elements[i].value));}
else if(nodeName==='SELECT'){if(nodeType==='select-multiple'){for(j=form.elements[i].options.length-1;j>=0;j=j-1){if(form.elements[i].options[j].selected)
q.push(form.elements[i].getAttribute('name')+'='+encodeURIComponent(form.elements[i].options[j].value));}}
else{q.push(form.elements[i].getAttribute('name')+'='+encodeURIComponent(form.elements[i].value));}}}
return q.join('&');}};if((typeof window.addEventListener==='function')&&(!/Presto|Opera.{1}12/.test(navigator.userAgent)))
window.addEventListener('load',apijs.start.bind(apijs),false);
apijs.core.error=function(method,title,data){var key,text=[];if(typeof data==='string'){text.push(data);}
else{for(key in data)if(data.hasOwnProperty(key))
text.push(key+' : '+data[key]);}
if(apijs.config.debug)
apijs.dialog.dialogInformation(apijs.i18n.translate(title),'[pre]'+method+'[br]➩ '+text.join('[br]➩ '),'debug');throw new Error(method+', '+text.join(' / '));};
apijs.core.i18n=function(){this.data=[];this.data.en={buttonOk:"Ok",buttonCancel:"Cancel",buttonConfirm:"Confirm",buttonClose:"Close",buttonPrev:"Previous",buttonNext:"Next",buttonBrowse:"Choose a file",userLeavePage:"You are about to leave...",operationTooLong:"This operation is too long? ",warningLostChange:"Warning: all changes in progress will be lost.",reloadLink:"Reload this page",operationInProgress:"Operation in progress...",uploadInProgress:"Upload in progress...",error404:"Error 404\n The file does not exist.",ctrlSlideshowFirstLast:"start/end",ctrlSlideshowNextPrev:"previous/next",ctrlVideoPause:"play/pause",ctrlVideoTime:"backward/forward",ctrlVideoSound:"decrease/increase the volume",ctrlVideoMute:"mute",ctrlDialogFullscreen:"full screen",ctrlDialogQuit:"quit",ctrlKeyEnd:"End",ctrlKeyEsc:"Escape",uploadAllType:"All files are accepted.[br]Maximum size: § MB.",uploadOneType:"Accepted file format: §.[br]Maximum size: § MB.",uploadMultiType:"Accepted file formats: § and §.[br]Maximum size: § MB.",uploadDecimal:".",upload10:"§% (§ KB/s)",upload11:"§% (§ KB/s - § minutes left)",upload12:"§% (§ KB/s - § minute left)",upload13:"§% (§ KB/s - § seconds left)",upload20:"§% (at § KB/s)",upload21:"§% (at § KB/s in § minutes)",upload22:"§% (at § KB/s in § minute)",upload23:"§% (at § KB/s in § seconds)",uploadBadType:"It's impossible to send the file because the proposed file format isn't allowed. Proposed file format: §.",uploadBadSize:"It's impossible to send the file because the file size is too large. Proposed file size: § MB.",uploadEmpty:"It's impossible to send the file because the file is empty.",uploadError1:"An error occurred while sending the file.[br][em]➩ Erreur §.[/em]",uploadError2:"An error occurred while processing the file.[/p][p]§",debugInvalidCall:"(debug) Invalid call",debugInvalidUse:"(debug) Invalid use",debugUnknownConfig:"Unknown configuration (§).",debugBadUse:"The upload dialog must be called with §."};this.data.fr={buttonOk:"Ok",buttonCancel:"Annuler",buttonConfirm:"Valider",buttonClose:"Fermer",buttonPrev:"Précédent",buttonNext:"Suivant",buttonBrowse:"Choisir un fichier",userLeavePage:"Vous vous apprêtez à partir...",operationTooLong:"Cette opération prend trop de temps ? ",warningLostChange:"Attention : toutes les modifications en cours seront perdues.",reloadLink:"Rechargez la page",operationInProgress:"Opération en cours...",uploadInProgress:"Envoi du fichier en cours...",error404:"Erreur 404\n Le fichier n'existe pas.",ctrlSlideshowFirstLast:"début/fin",ctrlSlideshowNextPrev:"précédent/suivant",ctrlVideoPause:"lecture/pause",ctrlVideoTime:"reculer/avancer",ctrlVideoSound:"baisser/augmenter le volume",ctrlVideoMute:"couper le son",ctrlDialogFullscreen:"plein écran",ctrlDialogQuit:"quitter",ctrlKeyEnd:"Fin",ctrlKeyEsc:"Échap",uploadAllType:"Tous les fichiers sont acceptés.[br]Taille maximale : § Mo.",uploadOneType:"Format de fichier accepté : §.[br]Taille maximale : § Mo.",uploadMultiType:"Formats de fichier acceptés : § et §.[br]Taille maximale : § Mo.",uploadDecimal:",",upload10:"§% (§ Ko/s)",upload11:"§% (§ Ko/s - § minutes restantes)",upload12:"§% (§ Ko/s - § minute restante)",upload13:"§% (§ Ko/s - § secondes restantes)",upload20:"§% (à § Ko/s)",upload21:"§% (à § Ko/s en § minutes)",upload22:"§% (à § Ko/s en § minute)",upload23:"§% (à § Ko/s en § secondes)",uploadBadType:"Il est impossible d'envoyer le fichier car le format du fichier proposé n'est pas autorisé. Format du fichier proposé : §.",uploadBadSize:"Il est impossible d'envoyer le fichier car la taille du fichier proposé est trop importante. Taille du fichier proposé : § Mo.",uploadEmpty:"Il est impossible d'envoyer le fichier car le fichier est vide.",uploadError1:"Une erreur est survenue lors de l'envoi du fichier.[br][em]➩ Erreur §.[/em]",uploadError2:"Une erreur est survenue lors du traitement du fichier.[/p][p]§"};this.init=function(){var autolang,html=document.querySelector('html');if(apijs.config.lang.indexOf('auto')>-1){if(html.getAttribute('xml:lang'))
autolang=html.getAttribute('xml:lang').slice(0,2);else if(html.getAttribute('lang'))
autolang=html.getAttribute('lang').slice(0,2);if((typeof autolang==='string')&&this.data.hasOwnProperty(autolang))
apijs.config.lang=autolang;else if(apijs.config.lang.indexOf('auto-')>-1)
apijs.config.lang=apijs.config.lang.slice(5);}
if(!this.data.hasOwnProperty(apijs.config.lang))
apijs.config.lang='en';};this.translate=function(word){var lang=apijs.config.lang,i=0,arg=1,translation='',data;if(typeof this.data[lang][word]!=='string'){if((lang!=='en')&&(typeof this.data.en[word]==='string'))
lang='en';else
return word;}
if(arguments.length>1){for(data=this.data[lang][word].split('§');i<data.length;i++)
translation+=(arg<arguments.length)?data[i]+arguments[arg++]:data[i];return translation;}
return this.data[lang][word];};this.nodeTranslate=function(word){return document.createTextNode(this.translate(word));};this.changeLang=function(lang){if(typeof lang==='string'){if(this.data.hasOwnProperty(lang)){apijs.config.lang=lang;return true;}
if(lang.indexOf('auto')>-1){apijs.config.lang=lang;this.init();return true;}}
return false;};};
apijs.core.dialog=function(){this.styles=null;this.paused=null;this.image=null;this.timer=null;this.callback=null;this.args=null;this.fragment=null;this.elemA=null;this.elemB=null;this.elemC=null;this.elemD=null;this.tagDialog=null;this.tagMedia=null;this.tagTitle=null;this.tagBox=null;this.dialogInformation=function(title,text,icon){if((typeof title==='string')&&(typeof text==='string')){this.initDialog('information',icon);this.htmlParent();this.htmlTitle(title);this.htmlContent(text);this.htmlButtonOk();this.showDialog();this.tagBox.querySelector('button.confirm').focus();}
else{apijs.core.error('TheDialog.dialogInformation','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(string) icon':icon});}};this.dialogConfirmation=function(title,text,callback,args,icon){if((typeof title==='string')&&(typeof text==='string')&&(typeof callback==='function')){this.initDialog('confirmation',icon);this.htmlParent();this.htmlTitle(title);this.htmlContent(text);this.htmlButtonConfirm('button');this.callback=callback;this.args=args;this.showDialog();this.tagBox.querySelector('button.confirm').focus();}
else{if((typeof callback==='function')&&(typeof callback.name==='string')&&(callback.name.length>0))
callback=callback.name;apijs.core.error('TheDialog.dialogConfirmation','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(function) *callback':callback,'(mixed) args':args,'(string) icon':icon});}};this.dialogFormOptions=function(title,text,action,callback,args,icon){if((typeof title==='string')&&(typeof text==='string')&&(typeof action==='string')&&(typeof callback==='function')){this.initDialog('options',icon);this.htmlParent(null,action);this.htmlTitle(title);this.htmlContent(text);this.htmlButtonConfirm('submit');this.callback=callback;this.args=args;this.showDialog();window.setTimeout(function(){apijs.dialog.tagBox.querySelector('input:not([readonly]),textarea:not([readonly]),select:not([disabled])').focus();},12);}
else{if((typeof callback==='function')&&(typeof callback.name==='string')&&(callback.name.length>0))
callback=callback.name;apijs.core.error('TheDialog.dialogFormOptions','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(string) *action':action,'(function) *callback':callback,'(mixed) args':args,'(string) icon':icon});}};this.dialogFormUpload=function(title,text,action,inputname,icon){if((typeof title==='string')&&(typeof text==='string')&&(typeof action==='string')&&(typeof inputname==='string')){this.initDialog('upload',icon);this.htmlParent(null,action);this.htmlTitle(title);this.htmlContent(text,false);this.htmlFormUpload(inputname);this.htmlButtonConfirm('submit');this.showDialog();window.setTimeout(function(){apijs.dialog.tagBox.querySelector('button').focus();},12);}
else{apijs.core.error('TheDialog.dialogFormUpload','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(string) *action':action,'(string) *inputname':inputname,'(string) icon':icon});}};this.dialogProgress=function(title,text,icon){if((typeof title==='string')&&(typeof text==='string')){this.initDialog('progress',icon);this.htmlParent();this.htmlTitle(title);this.htmlContent(text,false);this.htmlProgressBar();this.showDialog();}
else{apijs.core.error('TheDialog.dialogProgress','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(string) icon':icon});}};this.dialogWaiting=function(title,text,time,icon){if((typeof title==='string')&&(typeof text==='string')){this.initDialog('waiting',icon);this.htmlParent();this.htmlTitle(title);this.htmlContent(text,false);this.showDialog();if((typeof time==='number')&&(time>5))
this.timer=window.setTimeout(apijs.dialog.htmlLinkReload.bind(this),time*1000);}
else{apijs.core.error('TheDialog.dialogWaiting','debugInvalidCall',{'(string) *title':title,'(string) *text':text,'(number) time':time,'(string) icon':icon});}};this.dialogPhoto=function(url,name,date,legend,icon){if((typeof url==='string')&&(typeof name==='string')&&(typeof date==='string')&&(typeof legend==='string')){if(typeof icon==='string'){this.initDialog('photo','notransition slideshow');this.htmlParent(icon);}
else{this.initDialog('photo','notransition');this.htmlParent();}
this.htmlMedia(url,name,date,legend);this.htmlHelp((typeof icon==='string'),false);this.htmlButtonClose();this.htmlButtonNavigation();this.showDialog();this.loadImage(url);}
else{apijs.core.error('TheDialog.dialogPhoto','debugInvalidCall',{'(string) *url':url,'(string) *name':name,'(string) *date':date,'(string) *legend':legend});}};this.dialogVideo=function(url,name,date,legend,icon){if((typeof url==='string')&&(typeof name==='string')&&(typeof legend==='string')&&(typeof legend==='string')){if(typeof icon==='string'){this.initDialog('video','notransition slideshow');this.htmlParent(icon);}
else{this.initDialog('video','notransition');this.htmlParent();}
this.htmlMedia(url,name,date,legend);this.htmlHelp((typeof icon==='string'),true);this.htmlButtonClose();this.htmlButtonNavigation();this.showDialog();this.actionResizeMedia();}
else{apijs.core.error('TheDialog.dialogVideo','debugInvalidCall',{'(string) *url':url,'(string) *name':name,'(string) *date':date,'(string) *legend':legend});}};this.dialogEmpty=function(text,closeButton,okButton,icon){if(typeof text==='string'){this.initDialog('empty',icon);this.htmlParent();this.htmlContent(text);if(((typeof closeButton==='boolean')&&closeButton)||(okButton!==true))
this.htmlButtonClose();if((typeof okButton==='boolean')&&okButton)
this.htmlButtonOk();this.showDialog();if((typeof okButton==='boolean')&&okButton)
this.tagBox.querySelector('button.confirm').focus();}
else{apijs.core.error('TheDialog.dialogEmpty','debugInvalidCall',{'(string) *text':text,'(boolean) closeButton':closeButton,'(boolean) okButton':okButton,'(string) icon':icon});}};this.actionClose=function(all){if(document.getElementById('apijsDialog'))
this.deleteDialog((typeof all!=='boolean')||(all===true));};this.actionCloseOnClick=function(ev){if((ev.target.getAttribute('id')==='apijsDialog')&&!apijs.dialog.styles.has('photo','video','waiting','progress','lock'))
apijs.dialog.deleteDialog(true);};this.actionConfirm=function(){if(this.styles.has('upload')){if(apijs.upload.actionConfirm(this.tagBox.getAttribute('action'))){window.setTimeout(apijs.upload.showProgress,12);return true;}}
if(this.styles.has('options','confirmation')){if(this.styles.has('options')){if(this.callback(false,this.args)!==true)
return false;}
this.styles.add('lock');this.tagBox.querySelector('div.control').style.visibility='hidden';this.tagBox.querySelector('div.bbcode').style.visibility='hidden';this.elemA=document.createElement('p');this.elemA.setAttribute('class','saving');this.elemA.appendChild(apijs.i18n.nodeTranslate('operationInProgress'));this.tagBox.appendChild(this.elemA);this.timer=window.setTimeout(apijs.dialog.htmlLinkReload.bind(this),7000);window.setTimeout(function(){if((this.tagBox)&&(this.tagBox.nodeName==='FORM'))
this.callback(this.tagBox.getAttribute('action'),this.args);else if(this.tagBox)
this.callback(this.args);}.bind(this),1000);}
return false;};this.actionKey=function(ev){var styles=apijs.dialog.styles,media=apijs.dialog.tagMedia;if(styles.has('waiting','progress','lock')){if((ev.ctrlKey&&((ev.keyCode===81)||(ev.keyCode===87)||(ev.keyCode===82)||(ev.keyCode===115)||(ev.keyCode===116)))||(ev.altKey&&(ev.keyCode===115))||(ev.keyCode===27)||(ev.keyCode===116)){ev.preventDefault();}}
else if(styles.has('slideshow')){if(ev.keyCode===27){ev.preventDefault();apijs.dialog.actionClose(true);}
else if(ev.keyCode===35){ev.preventDefault();apijs.slideshow.actionLast();}
else if(ev.keyCode===36){ev.preventDefault();apijs.slideshow.actionFirst();}
else if(ev.keyCode===37){ev.preventDefault();apijs.slideshow.actionPrev();}
else if(ev.keyCode===39){ev.preventDefault();apijs.slideshow.actionNext();}}
else if(ev.keyCode===27){ev.preventDefault();apijs.dialog.actionClose(true);}
if(styles.has('video')&&!isNaN(media.duration)){if((ev.keyCode===32)||(ev.keyCode===80)){ev.preventDefault();if(media.paused){media.play();}else{media.pause();}}
else if((ev.keyCode===38)||(ev.keyCode===33)){ev.preventDefault();if(media.currentTime<(media.duration-15))
media.currentTime+=10;}
else if((ev.keyCode===40)||(ev.keyCode===34)){ev.preventDefault();media.currentTime-=10;}
else if(ev.keyCode===107){ev.preventDefault();if(media.volume<1)
media.volume+=0.2;}
else if(ev.keyCode===109){ev.preventDefault();if(media.volume>0.2)
media.volume-=0.2;}
else if(ev.keyCode===77){ev.preventDefault();media.muted=(media.muted)?false:true;}}
if((ev.keyCode===32)||(ev.keyCode===33)||(ev.keyCode===34)||(ev.keyCode===35)||(ev.keyCode===36)||(ev.keyCode===38)||(ev.keyCode===40)){var inputText=(ev.target.nodeName==='INPUT'),inputTextarea=(ev.target.nodeName==='TEXTAREA'),inputSelect=(ev.target.nodeName==='SELECT');if((!inputText&&!inputTextarea&&!inputSelect)||(ev.keyCode===33)||(ev.keyCode===34))
apijs.dialog.actionScrollBrowser(ev);}};this.actionCloseBrowser=function(ev){if(apijs.dialog.styles.has('waiting','progress','lock')){ev.preventDefault();ev.stopPropagation();return apijs.i18n.translate('userLeavePage')+'\n'+apijs.i18n.translate('warningLostChange');}};this.actionScrollBrowser=function(ev){ev.preventDefault();ev.stopPropagation();};this.actionResizeMedia=function(){var image=apijs.dialog.image,bis=false;if(image!==null){if((image.width>Math.round(apijs.dialog.tagMedia.offsetWidth))||(image.height>Math.round(apijs.dialog.tagMedia.offsetHeight)))
bis=true;}
else{apijs.dialog.tagMedia.setAttribute('class',apijs.dialog.tagMedia.getAttribute('class').replace('bis','default'));if(Math.round(apijs.dialog.tagMedia.offsetWidth)>(window.innerWidth-window.innerWidth*12/100))
bis=true;apijs.dialog.tagMedia.setAttribute('class',apijs.dialog.tagMedia.getAttribute('class').replace('default','bis'));}
apijs.dialog.tagMedia.setAttribute('class',apijs.dialog.tagMedia.getAttribute('class').replace((bis)?'default':'bis',(bis)?'bis':'default'));};this.actionPauseVideo=function(){var hidden;if(typeof document.hidden==='boolean')
hidden=document.hidden;else if(typeof document.mozHidden==='boolean')
hidden=document.mozHidden;else if(typeof document.msHidden==='boolean')
hidden=document.msHidden;else if(typeof document.webkitHidden==='boolean')
hidden=document.webkitHidden;if(hidden){apijs.dialog.paused=apijs.dialog.tagMedia.paused;apijs.dialog.tagMedia.pause();}
else if(!apijs.dialog.paused){apijs.dialog.tagMedia.play();}};this.loadImage=function(url){this.image=new Image();this.image.src=url;this.image.addEventListener('load',function(){this.tagMedia.setAttribute('class',this.tagMedia.getAttribute('class').replace('loading','default'));this.tagMedia.setAttribute('style','background-image:url("'+this.image.src+'");');this.actionResizeMedia();}.bind(this),false);this.image.addEventListener('error',function(){this.tagMedia.setAttribute('class',this.tagMedia.getAttribute('class').replace(/loading|default/,'error'));this.tagMedia.firstChild.appendChild(apijs.i18n.nodeTranslate('error404'));}.bind(this),false);};this.initDialog=function(type,icon){if(this.styles!==null)
this.deleteDialog(false);this.styles=new apijs.core.styles();this.styles.init(type,icon);this.fragment=document.createDocumentFragment();document.addEventListener('keydown',apijs.dialog.actionKey,false);window.addEventListener('beforeunload',apijs.dialog.actionCloseBrowser,false);window.addEventListener('DOMMouseScroll',apijs.dialog.actionScrollBrowser,false);window.addEventListener('mousewheel',apijs.dialog.actionScrollBrowser,false);window.addEventListener('touchmove',apijs.dialog.actionScrollBrowser,false);if(apijs.config.dialog.restrictNavigation){var elem,elems=document.querySelectorAll('a,area,button,input,object,select,textarea,iframe');for(elem=0;elem<elems.length;elem++){if(typeof elems[elem]==='object')
elems[elem].setAttribute('tabindex','-1');}}};this.showDialog=function(){if(document.getElementById('apijsDialog')||this.styles.has('notransition')){this.tagDialog.setAttribute('class',this.tagDialog.getAttribute('class').replace('start','ready'));this.tagBox.setAttribute('class',this.tagBox.getAttribute('class').replace('start','ready'));if(document.getElementById('apijsDialog')){document.getElementById('apijsDialog').appendChild(this.tagBox);this.tagDialog=document.getElementById('apijsDialog');}
else{document.body.appendChild(this.fragment);}}
else{document.body.appendChild(this.fragment);window.setTimeout(function(){this.tagDialog.setAttribute('class',this.tagDialog.getAttribute('class').replace('start','ready'));this.tagBox.setAttribute('class',this.tagBox.getAttribute('class').replace('start','ready'));}.bind(this),12);}
if(apijs.config.dialog.closeOnClick&&!this.styles.has('waiting','progress','lock'))
document.addEventListener('click',apijs.dialog.actionCloseOnClick,false);if(this.styles.has('photo','video'))
window.addEventListener('resize',apijs.dialog.actionResizeMedia,false);if(this.styles.has('video')){if(typeof document.hidden==='boolean')
document.addEventListener('visibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.mozHidden==='boolean')
document.addEventListener('mozvisibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.msHidden==='boolean')
document.addEventListener('msvisibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.webkitHidden==='boolean')
document.addEventListener('webkitvisibilitychange',apijs.dialog.actionPauseVideo,false);}};this.deleteDialog=function(all){if(this.timer)
clearTimeout(this.timer);document.removeEventListener('keydown',apijs.dialog.actionKey,false);window.removeEventListener('beforeunload',apijs.dialog.actionCloseBrowser,false);window.removeEventListener('DOMMouseScroll',apijs.dialog.actionScrollBrowser,false);window.removeEventListener('mousewheel',apijs.dialog.actionScrollBrowser,false);window.removeEventListener('touchmove',apijs.dialog.actionScrollBrowser,false);if(apijs.config.dialog.restrictNavigation){var elem,elems=document.querySelectorAll('a,area,button,input,object,select,textarea,iframe');for(elem=0;elem<elems.length;elem++){if(typeof elems[elem]==='object')
elems[elem].removeAttribute('tabindex');}}
if(apijs.config.dialog.closeOnClick)
document.removeEventListener('click',apijs.dialog.actionCloseOnClick,false);if(this.styles.has('photo','video'))
window.removeEventListener('resize',apijs.dialog.actionResizeMedia,false);if(this.styles.has('video')){if(typeof this.tagMedia.pause==='function'){this.tagMedia.pause();this.tagMedia.setAttribute('src','');}
if(typeof document.hidden==='boolean')
document.removeEventListener('visibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.mozHidden==='boolean')
document.removeEventListener('mozvisibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.msHidden==='boolean')
document.removeEventListener('msvisibilitychange',apijs.dialog.actionPauseVideo,false);else if(typeof document.webkitHidden==='boolean')
document.removeEventListener('webkitvisibilitychange',apijs.dialog.actionPauseVideo,false);}
this.tagDialog=document.getElementById('apijsDialog');this.tagBox=document.getElementById('apijsBox');if(all){var styles=window.getComputedStyle(this.tagBox,null),event=(typeof this.tagBox.style.webkitTransition==='string')?'webkitTransitionEnd':'transitionend';if(!this.styles.has('notransition')&&(styles.transitionDuration!=='0s')&&(styles.transitionDuration!==undefined)){this.tagDialog.setAttribute('class',this.tagDialog.getAttribute('class').replace('ready','end'));this.tagBox.setAttribute('class',this.tagBox.getAttribute('class').replace('ready','end'));this.tagDialog.addEventListener(event,function(){if(document.getElementById('apijsDialog'))
document.body.removeChild(document.getElementById('apijsDialog'));},false);}
else{document.body.removeChild(document.getElementById('apijsDialog'));}}
else if(this.tagBox){this.tagBox.parentNode.removeChild(this.tagBox);}
this.styles=null;this.paused=null;this.image=null;this.timer=null;if(all){this.callback=null;this.args=null;}
this.fragment=null;this.elemA=null;this.elemB=null;this.elemC=null;this.elemD=null;this.tagDialog=null;this.tagMedia=null;this.tagTitle=null;this.tagBox=null;};this.searchTypes=function(url){var types=[],i,list,all={jpg:'image/jpeg',jpeg:'image/jpeg',png:'image/png',svg:'image/svg+xml',ogv:'video/ogg',webm:'video/webm',mp4:'video/mp4',m4v:'video/mp4'};url=url.slice(url.lastIndexOf('.')+1);list=url.replace('#','.').replace(',','.').split('.');for(i=0;i<list.length;i++)
types.push(all.hasOwnProperty(list[i])?[list[i],all[list[i]]]:[list[i],list[i]]);return types;};this.htmlParent=function(icon,action){this.tagDialog=document.createElement('div');this.tagDialog.setAttribute('class',(typeof icon==='string')?'start '+icon:'start');this.tagDialog.setAttribute('id','apijsDialog');if(typeof action!=='string'){this.tagBox=document.createElement('div');}
else{this.tagBox=document.createElement('form');this.tagBox.setAttribute('action',action);this.tagBox.setAttribute('method','post');this.tagBox.setAttribute('enctype','multipart/form-data');this.tagBox.setAttribute('onsubmit','return apijs.dialog.actionConfirm();');}
this.tagBox.setAttribute('class','start '+this.styles.toString());this.tagBox.setAttribute('id','apijsBox');this.tagDialog.appendChild(this.tagBox);this.fragment.appendChild(this.tagDialog);};this.htmlTitle=function(title){this.tagTitle=document.createElement('h1');this.tagTitle.appendChild(document.createTextNode(title));this.tagBox.appendChild(this.tagTitle);};this.htmlContent=function(data,allowEmotes){allowEmotes=(typeof allowEmotes==='boolean')?allowEmotes:true;this.elemA=document.createElement('div');this.elemA.setAttribute('class',(apijs.config.dialog.emotes)?'bbcode emotes':'bbcode');if(data[0]!=='[')
data='[p]'+data+'[/p]';if(apijs.config.dialog.emotes&&allowEmotes){data=data.replace(/ (\(L\))/g,'`$1`00¤').replace(/ (\(u\))/ig,'`$1`01¤').replace(/ (\(y\))/ig,'`$1`02¤').replace(/ (\(n\))/ig,'`$1`03¤').replace(/ (:D)/ig,'`$1`04¤').replace(/ (:\))/g,'`$1`05¤').replace(/ (:p)/ig,'`$1`06¤').replace(/ (:\()/g,'`$1`07¤').replace(/ (;\))/g,'`$1`08¤').replace(/ (:lol)/ig,'`$1`09¤').replace(/ (8\))/g,'`$1`0a¤').replace(/ (:@)/g,'`$1`0b¤').replace(/ (\(6\))/g,'`$1`0c¤').replace(/ (:o)/ig,'`$1`0d¤').replace(/ (\(\!\))/g,'`$1`0e¤').replace(/ (\(\?\))/g,'`$1`0f¤').replace(/ (:s)/ig,'`$1`10¤').replace(/ (:\|)/g,'`$1`11¤').replace(/ (:\/)/g,'`$1`12¤').replace(/ (\(i\))/ig,'`$1`13¤').replace(/`(.{2,4})`([0-9a-f]{2})¤/g,' [span title="$1" class="ico"]&#xe6$2;[/span]');}
this.elemA.innerHTML=data.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\[/g,'<').replace(/\]/g,'>');var link,links=this.elemA.querySelectorAll('a.popup');for(link=0;link<links.length;link++)
links[link].addEventListener('click',apijs.openTab,false);this.tagBox.appendChild(this.elemA);};this.htmlButtonOk=function(){this.elemA=document.createElement('div');this.elemA.setAttribute('class','control');this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('onclick','apijs.dialog.actionClose(true);');this.elemB.setAttribute('class','confirm');this.elemB.appendChild(apijs.i18n.nodeTranslate('buttonOk'));this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlButtonConfirm=function(type){this.elemA=document.createElement('div');this.elemA.setAttribute('class','control');this.elemB=document.createElement('button');this.elemB.setAttribute('type',type);this.elemB.setAttribute('class','confirm');if(type!=='submit')
this.elemB.setAttribute('onclick','apijs.dialog.actionConfirm();');this.elemB.appendChild(apijs.i18n.nodeTranslate('buttonConfirm'));this.elemA.appendChild(this.elemB);this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('class','cancel');this.elemB.setAttribute('onclick','apijs.dialog.actionClose(true);');this.elemB.appendChild(apijs.i18n.nodeTranslate('buttonCancel'));this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlButtonNavigation=function(){var txt=((apijs.config.dialog.imagePrev===null)||(apijs.config.dialog.imageNext===null));this.elemA=document.createElement('div');this.elemA.setAttribute('class',(txt)?'navigation txt':'navigation img');this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('disabled','disabled');this.elemB.setAttribute('onclick','apijs.slideshow.actionPrev();');this.elemB.setAttribute('class','prev');this.elemB.setAttribute('id','apijsPrev');if(txt){this.elemC=document.createElement('span');this.elemC.appendChild(apijs.i18n.nodeTranslate('buttonPrev'));}
else{this.elemC=document.createElement('img');this.elemC.setAttribute('src',apijs.config.dialog.imagePrev.src);this.elemC.setAttribute('width',apijs.config.dialog.imagePrev.width);this.elemC.setAttribute('height',apijs.config.dialog.imagePrev.height);this.elemC.setAttribute('alt',apijs.i18n.translate('buttonPrev'));}
this.elemB.appendChild(this.elemC);this.elemA.appendChild(this.elemB);this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('disabled','disabled');this.elemB.setAttribute('onclick','apijs.slideshow.actionNext();');this.elemB.setAttribute('class','next');this.elemB.setAttribute('id','apijsNext');if(txt){this.elemC=document.createElement('span');this.elemC.appendChild(apijs.i18n.nodeTranslate('buttonNext'));}
else{this.elemC=document.createElement('img');this.elemC.setAttribute('src',apijs.config.dialog.imageNext.src);this.elemC.setAttribute('width',apijs.config.dialog.imageNext.width);this.elemC.setAttribute('height',apijs.config.dialog.imageNext.height);this.elemC.setAttribute('alt',apijs.i18n.translate('buttonNext'));}
this.elemB.appendChild(this.elemC);this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlButtonClose=function(){var txt=(apijs.config.dialog.imageClose===null);this.elemA=document.createElement('div');this.elemA.setAttribute('class',(txt)?'close txt':'close img');this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('onclick','apijs.dialog.actionClose(true);');this.elemB.setAttribute('class','close');if(txt){this.elemB.appendChild(apijs.i18n.nodeTranslate('buttonClose'));}
else{this.elemC=document.createElement('img');this.elemC.setAttribute('src',apijs.config.dialog.imageClose.src);this.elemC.setAttribute('width',apijs.config.dialog.imageClose.width);this.elemC.setAttribute('height',apijs.config.dialog.imageClose.height);this.elemC.setAttribute('alt',apijs.i18n.translate('buttonClose'));this.elemB.appendChild(this.elemC);}
this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlLinkReload=function(){this.elemA=document.createElement('p');this.elemA.setAttribute('class','reload');this.elemA.appendChild(apijs.i18n.nodeTranslate('operationTooLong'));this.elemB=document.createElement('a');this.elemB.setAttribute('href','javascript:location.reload();');this.elemB.appendChild(apijs.i18n.nodeTranslate('reloadLink'));this.elemA.appendChild(this.elemB);this.elemA.appendChild(document.createTextNode('.'));this.elemB=document.createElement('br');this.elemA.appendChild(this.elemB);this.elemA.appendChild(apijs.i18n.nodeTranslate('warningLostChange'));this.tagBox.appendChild(this.elemA);};this.htmlFormUpload=function(inputname){this.elemA=document.createElement('div');this.elemA.setAttribute('class','control online');this.elemB=document.createElement('input');this.elemB.setAttribute('type','file');this.elemB.setAttribute('name',inputname);this.elemB.setAttribute('onchange',"apijs.dialog.tagBox.querySelector('button.confirm').focus(); apijs.dialog.tagBox.querySelector('span').innerHTML = (this.files) ? this.files[0].name : this.value.slice(12);");if(navigator.userAgent.indexOf('MSIE')>0)
this.elemB.setAttribute('style','width:auto; visibility:visible;');this.elemA.appendChild(this.elemB);this.elemB=document.createElement('button');this.elemB.setAttribute('type','button');this.elemB.setAttribute('class','browse');this.elemB.setAttribute('onclick',"apijs.dialog.tagBox.querySelector('input').click();");this.elemB.appendChild(apijs.i18n.nodeTranslate('buttonBrowse'));if(navigator.userAgent.indexOf('MSIE')>0)
this.elemB.setAttribute('style','display:none;');this.elemA.appendChild(this.elemB);this.elemB=document.createElement('span');this.elemB.setAttribute('class','filename');this.elemA.appendChild(this.elemB);this.elemB=document.createElement('div');this.elemB.setAttribute('class','status');this.elemB.appendChild(document.createTextNode(''));this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlProgressBar=function(){this.elemA=document.createElement('svg');this.elemA.setAttribute('xmlns','http://www.w3.org/2000/svg');this.elemA.setAttribute('version','1.1');this.elemA.setAttribute('id','apijsProgress');this.elemB=document.createElement('rect');this.elemB.setAttribute('class','auto');this.elemA.appendChild(this.elemB);this.elemB=document.createElement('text');this.elemB.appendChild(document.createTextNode('\u00A0'));this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlMedia=function(url,name,date,legend){var types=this.searchTypes(url),fileid=url.slice((url.lastIndexOf('/')+1),url.lastIndexOf('.')),i;this.elemA=document.createElement('dl');this.elemA.setAttribute('class','media');this.elemB=document.createElement('dt');if(types[0][1].indexOf('image')>-1){this.tagMedia=document.createElement('div');this.tagMedia.setAttribute('class','img loading');this.tagMedia.setAttribute('id','apijsMedia');this.elemD=document.createElement('span');this.tagMedia.appendChild(this.elemD);}
else{this.tagMedia=document.createElement('video');this.tagMedia.setAttribute('controls','controls');this.tagMedia.setAttribute('class','default');this.tagMedia.setAttribute('id','apijsMedia');for(i=0;i<types.length;i++){this.elemD=document.createElement('source');this.elemD.setAttribute('src',url.slice(0,url.lastIndexOf('.'))+'.'+types[i][0]);this.elemD.setAttribute('type',types[i][1]);this.tagMedia.appendChild(this.elemD);}}
this.elemB.appendChild(this.tagMedia);this.elemA.appendChild(this.elemB);this.elemB=document.createElement('dd');if((name!=='false')||(date!=='false')){this.elemC=document.createElement('span');if((name!=='false')&&(name!=='auto')&&(date!=='false'))
this.elemC.appendChild(document.createTextNode(name+' ('+date+')'));else if((name!=='false')&&(name!=='auto'))
this.elemC.appendChild(document.createTextNode(name));else if((name==='auto')&&(date!=='false'))
this.elemC.appendChild(document.createTextNode(fileid+' ('+date+')'));else if(name==='auto')
this.elemC.appendChild(document.createTextNode(fileid));else if(date!=='false')
this.elemC.appendChild(document.createTextNode('('+date+')'));this.elemB.appendChild(this.elemC);}
this.elemB.appendChild(document.createTextNode(' '+legend+' '));this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};this.htmlHelp=function(slideshow,video){var i,j,tmp,total,data=[];if(slideshow){data.push(['start;↖','ctrlKeyEnd','ctrlSlideshowFirstLast']);data.push(['left;←','right;→','ctrlSlideshowNextPrev']);}
if(video){data.push(['p','ctrlVideoPause']);data.push(['top;↑','bot;↓','ctrlVideoTime']);data.push(['more;+','less;-','ctrlVideoSound']);data.push(['m','ctrlVideoMute']);}
data.push(['F11','ctrlDialogFullscreen']);data.push(['ctrlKeyEsc','ctrlDialogQuit']);this.elemA=document.createElement('div');this.elemA.setAttribute('class','kbd');this.elemB=document.createElement('ul');for(i=0;i<data.length;i++){total=data[i].length-1;this.elemC=document.createElement('li');for(j=0;j<total;j++){this.elemD=document.createElement('kbd');if(data[i][j].indexOf(';')>0){tmp=data[i][j].split(';');this.elemD.setAttribute('class',tmp[0]);this.elemD.setAttribute('title',tmp[1]);}
else{this.elemD.appendChild(apijs.i18n.nodeTranslate(data[i][j]));}
this.elemC.appendChild(this.elemD);}
this.elemC.appendChild(apijs.i18n.nodeTranslate(data[i][total]));this.elemB.appendChild(this.elemC);}
this.elemA.appendChild(this.elemB);this.tagBox.appendChild(this.elemA);};};apijs.core.styles=function(){this.data=[];this.init=function(type,icon){this.data.push(type);if(typeof icon==='string')
this.data=this.data.concat(icon.split(' '));};this.add=function(value){if(!this.data.hasOwnProperty(value))
this.data.push(value);return this.data;};this.toggle=function(search,replace){if(this.has(search))
this.remove(search);if(!this.has(replace))
this.add(replace);};this.has=function(){return(this.data!==null)?apijs.inArray(this.data,Array.prototype.slice.call(arguments,0)):false;};this.remove=function(){var arg,args=Array.prototype.slice.call(arguments,0);for(arg in args)if(args.hasOwnProperty(arg))
this.data.splice(this.data.indexOf(args[arg]),1);return this.data;};this.toString=function(){return this.data.join(' ');};};
apijs.core.slideshow=function(){this.current=null;this.init=function(){var i,j,ids=apijs.config.slideshow.ids,hoverload=false;for(i=0;document.getElementById(ids+'.'+i)!==null;i++){hoverload=(document.getElementById(ids+'.'+i).getAttribute('class').indexOf('hoverload')>-1);for(j=0;document.getElementById(ids+'.'+i+'.'+j)!==null;j++){document.getElementById(ids+'.'+i+'.'+j).addEventListener('click',apijs.slideshow.showMedia.bind(this),false);if(hoverload)
document.getElementById(ids+'.'+i+'.'+j).addEventListener('mouseover',apijs.slideshow.showMedia.bind(this),false);}
if(document.getElementById(ids+'.'+i+'.999'))
document.getElementById(ids+'.'+i+'.999').addEventListener('click',apijs.slideshow.showMedia.bind(this),false);}};this.showMedia=function(ev){var media={},source,realsource,mimetype;if(typeof ev!=='string'){ev.preventDefault();source=(ev.target.nodeName==='A')?ev.target:ev.target.parentNode;media.id=source.getAttribute('id');if(source.hasAttribute('class')&&(source.getAttribute('class').indexOf('current')>-1))
return;}
else{source=document.getElementById(ev);media.id=ev;}
media.prefix=apijs.config.slideshow.ids+'.'+media.id.split('.')[1];media.url=source.getAttribute('href');media.config=source.querySelector('input').getAttribute('value').split('|');media.number=parseInt(media.id.split('.')[2],10);media.styles=document.getElementById(media.prefix).getAttribute('class');media.styles=media.styles.replace(/gallery|album/g,'slideshow');media.presentation=document.getElementById(media.prefix+'.999');if(((media.config.length===4)&&media.presentation)||(media.config.length===3)){var currentLink=document.getElementById(media.id),currentImg=currentLink.querySelector('img'),allImages=document.getElementById(media.prefix).querySelectorAll('img'),i;if((media.config.length===4)&&(media.config[0]!=='null')){media.presentation.setAttribute('href',currentLink.getAttribute('href'));media.presentation.querySelector('img').setAttribute('src',media.config.shift());media.presentation.querySelector('img').setAttribute('alt',currentImg.getAttribute('alt'));media.presentation.querySelector('input').setAttribute('value',media.config.join('|'));media.presentation.setAttribute('class',currentLink.getAttribute('id'));}
if(media.config[0]==='null')
media.config.shift();if(currentImg&&(media.number!==999)){for(i=0;i<allImages.length;i++){if(allImages[i].hasAttribute('class'))
allImages[i].removeAttribute('class');}
currentImg.setAttribute('class','current');}
if(media.presentation){if(media.number===999){realsource=document.getElementById((source.hasAttribute('class'))?source.getAttribute('class'):media.prefix+'.0');mimetype=realsource.getAttribute('type');media.number=parseInt(realsource.getAttribute('id').split('.')[2],10);}
else if((apijs.dialog.styles!==null)&&apijs.dialog.styles.has('slideshow')){mimetype=document.getElementById(media.id).getAttribute('type');}}
else{mimetype=source.getAttribute('type');}
if(typeof mimetype==='string'){media.type=mimetype.substr(0,5).replace('image','dialogPhoto').replace('video','dialogVideo');this.showDialog(media);}}
else{apijs.core.error('TheSlideshow.showMedia','debugInvalidUse',apijs.i18n.translate('debugUnknownConfig',media.config.join(' | ')));}};this.showDialog=function(media){apijs.dialog[media.type](media.url,media.config[0],media.config[1],media.config[2],media.styles);if((apijs.dialog.styles!==null)&&apijs.dialog.styles.has('slideshow')){this.current={number:media.number,first:null,prev:null,next:null,last:null,total:null};this.current.total=document.getElementById(media.prefix).querySelectorAll('a[id][type]').length-1;this.current.total=(media.presentation)?this.current.total-1:this.current.total;this.current.first=media.prefix+'.0';this.current.prev=(media.number>0)?media.prefix+'.'+(this.current.number-1):null;this.current.next=(media.number<this.current.total)?media.prefix+'.'+(this.current.number+1):null;this.current.last=media.prefix+'.'+this.current.total;if(this.current.prev!==null)
document.getElementById('apijsPrev').removeAttribute('disabled');if(this.current.next!==null)
document.getElementById('apijsNext').removeAttribute('disabled');}
else{this.current=null;}};this.actionFirst=function(){if((this.current!==null)&&(this.current.number>0)&&(this.current.number<=this.current.total))
this.showMedia(this.current.first);};this.actionPrev=function(){if((this.current!==null)&&(this.current.prev!==null)&&(this.current.number>0))
this.showMedia(this.current.prev);};this.actionNext=function(){if((this.current!==null)&&(this.current.next!==null)&&(this.current.number<this.current.total))
this.showMedia(this.current.next);};this.actionLast=function(){if((this.current!==null)&&(this.current.number>=0)&&(this.current.number<this.current.total))
this.showMedia(this.current.last);};};
apijs.core.upload=function(){this.maxsize=0;this.extensions=null;this.callback=null;this.args=null;this.icon=null;this.startTime=0;this.updatedTime=0;this.fileId=null;this.sendFile=function(title,action,inputname,maxsize,extensions,callback,args,icon){if((typeof title==='string')&&(typeof action==='string')&&(typeof inputname==='string')&&(typeof maxsize==='number')&&(typeof extensions==='string')&&(typeof callback==='function')){this.maxsize=maxsize;this.extensions=extensions.split(',');this.callback=callback;this.args=args;this.icon=icon;var text;maxsize=maxsize.toFixed(2).replace('.00','').replace('.',apijs.i18n.translate('uploadDecimal'));if(this.extensions[0]==='*')
text=apijs.i18n.translate('uploadAllType',maxsize);else if(this.extensions.length===1)
text=apijs.i18n.translate('uploadOneType',extensions,maxsize);else
text=apijs.i18n.translate('uploadMultiType',this.extensions.slice(0,-1).join(', '),this.extensions.slice(-1),maxsize);apijs.dialog.dialogFormUpload(title,text,action,inputname,icon);}
else{if((typeof callback==='function')&&(typeof callback.name==='string')&&(callback.name.length>0))
callback=callback.name;apijs.core.error('TheUpload.sendFile','debugInvalidCall',{'(string) *title':title,'(string) *action':action,'(string) *inputname':inputname,'(number) *maxsize':maxsize,'(string) *extensions':extensions,'(function) *callback':callback,'(mixed) args':args,'(string) icon':icon,});}};this.actionConfirm=function(action){if(this.extensions===null){window.setTimeout(apijs.upload.showDebug,12);return false;}
var tagInput=apijs.dialog.tagBox.querySelector('input'),tagError=apijs.dialog.tagBox.querySelector('div.status').firstChild,checks={filePresent:false,fileFormat:false,fileSize:false,format:'',size:this.maxsize};if(tagInput.value.length>0){checks.filePresent=true;if(typeof tagInput.files==='object'){checks.format=tagInput.files[0].name;checks.format=checks.format.slice(checks.format.lastIndexOf('.')+1).toLowerCase();checks.size=tagInput.files[0].size;}
else{checks.format=tagInput.value.slice(12);checks.format=checks.format.slice(checks.format.lastIndexOf('.')+1).toLowerCase();}
if((this.extensions[0]==='*')||apijs.inArray(checks.format,this.extensions))
checks.fileFormat=true;if((checks.size>0)&&(checks.size<=this.maxsize*1048576))
checks.fileSize=true;}
if(checks.filePresent&&checks.fileFormat&&checks.fileSize){if(((typeof FormData==='function')||(typeof FormData==='object'))&&(typeof tagInput.files==='object')&&(action.indexOf('forceNoAjax')<0)&&(navigator.userAgent.indexOf('MSIE')<0)&&(navigator.userAgent.indexOf('Trident')<0)){this.startTime=this.updatedTime=Math.round(new Date().getTime()/1000);this.startAsynchronousUpload(action);this.showProgress();}
else{return true;}}
else{if(checks.filePresent&&!checks.fileFormat){tagError.replaceData(0,tagError.nodeValue.length,apijs.i18n.translate('uploadBadType',checks.format));}
else if(checks.filePresent&&!checks.fileSize){if(checks.size>0){checks.size=(checks.size/1048576).toFixed(2).replace('.00','').replace('.',apijs.i18n.translate('uploadDecimal'));tagError.replaceData(0,tagError.nodeValue.length,apijs.i18n.translate('uploadBadSize',checks.size));}
else{tagError.replaceData(0,tagError.nodeValue.length,apijs.i18n.translate('uploadEmpty'));}}
apijs.dialog.tagBox.querySelector('button.browse').focus();}
return false;};this.showProgress=function(){apijs.dialog.dialogProgress(apijs.dialog.tagTitle.firstChild.nodeValue,apijs.i18n.translate('uploadInProgress'),apijs.upload.icon);if((navigator.userAgent.indexOf('Safari')>0)&&(navigator.userAgent.indexOf('AppleWebkit')>0))
apijs.dialog.styles.remove('lock');};this.showError=function(){apijs.dialog.dialogInformation(apijs.dialog.tagTitle.firstChild.nodeValue,apijs.i18n.translate(this.fileId[0],this.fileId[1]),'upload error');this.setPageTitle(null);};this.showDebug=function(){apijs.core.error('TheUpload.actionConfirm','debugInvalidUse',apijs.i18n.translate('debugBadUse','apijs.upload.sendFile()'));};this.startAsynchronousUpload=function(action){var form=new FormData(),xhr=new XMLHttpRequest();form.append(apijs.dialog.tagBox.querySelector('input').getAttribute('name'),apijs.dialog.tagBox.querySelector('input').files[0]);xhr.open('POST',action+((action.indexOf('?')>0)?'&isAjax=true':'?isAjax=true'),true);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){if(xhr.responseText.indexOf('success-')===0){apijs.upload.fileId=['success',xhr.responseText.slice(8)];window.setTimeout(apijs.upload.uploadOnSuccess.bind(apijs.upload),3000);}
else{apijs.upload.fileId=['uploadError2',xhr.responseText];window.setTimeout(apijs.upload.showError.bind(apijs.upload),1500);}}
else{apijs.upload.fileId=['uploadError1',xhr.status];window.setTimeout(apijs.upload.showError.bind(apijs.upload),1500);}}};xhr.upload.addEventListener('progress',apijs.upload.uploadOnProgress,false);xhr.upload.addEventListener('load',apijs.upload.uploadOnLoad,false);xhr.send(form);};this.uploadOnProgress=function(ev){var percent,key=null,rate=null,time=null,elapsedTime,totalTime,currentTime=Math.round(new Date().getTime()/1000);if(ev.lengthComputable&&(currentTime>(apijs.upload.updatedTime+1))){apijs.upload.updatedTime=currentTime;percent=Math.round((ev.loaded*100)/ev.total);if((percent<1)||(percent>99))
return;apijs.upload.setPageTitle(percent);elapsedTime=currentTime-apijs.upload.startTime;totalTime=elapsedTime*100/percent;if(elapsedTime>4){rate=Math.round(ev.loaded/elapsedTime/1024);time=Math.round(totalTime-elapsedTime);if(elapsedTime<10){key=10;time=null;}
else if(time>119){key=11;time=Math.round(time/60);}
else if(time>89){key=11;time=2;}
else if(time>57){key=12;time=1;}
else if(time>45){key=13;time=50;}
else if(time>35){key=13;time=40;}
else if(time>25){key=13;time=30;}
else if(time>15){key=13;time=20;}
else{key=13;time=10;}}
apijs.upload.animToValue(percent,key,rate,time);}};this.uploadOnLoad=function(ev){var time=Math.round(new Date().getTime()/1000)-apijs.upload.startTime,rate=Math.round(ev.loaded/time/1024),key=null;if(rate<1){rate=null;time=null;}
else if(time>90){key=21;time=Math.round(time/60);}
else if(time>59){key=22;time=1;}
else if(time>9){key=23;}
else if((rate>0)&&(rate!==Infinity)){key=20;time=null;}
else{rate=null;time=null;}
apijs.upload.setPageTitle(100);apijs.upload.animToValue(100,key,rate,time);};this.uploadOnSuccess=function(){this.setPageTitle(null);this.callback(this.fileId[1],this.args);this.maxsize=0;this.extensions=null;this.callback=null;this.args=null;this.icon=null;this.startTime=0;this.updatedTime=0;this.fileid=null;};this.setPageTitle=function(percent){if(percent!==null){document.title=(/^[0-9]{1,3}% - /.test(document.title))?percent+'% - '+document.title.slice(document.title.indexOf(' - ')+3):percent+'% - '+document.title;}
else if(/^[0-9]{1,3}% - /.test(document.title)){document.title=document.title.slice(document.title.indexOf(' - ')+3);}};this.animToValue=function(percent,key,rate,time){var rect=document.getElementById('apijsProgress').querySelector('rect'),text=document.getElementById('apijsProgress').querySelector('text').firstChild,data;if(percent>99){rect.setAttribute('class','end');rect.style.width='';data='100%';}
else{rect.style.width=data=percent+'%';if(rect.hasAttribute('class'))
rect.removeAttribute('class');}
if((typeof key==='number')&&(typeof rate==='number')&&(typeof time==='number'))
data=apijs.i18n.translate('upload'+key,percent,rate,time);else if((typeof key==='number')&&(typeof rate==='number'))
data=apijs.i18n.translate('upload'+key,percent,rate);text.replaceData(0,text.length,data);};};